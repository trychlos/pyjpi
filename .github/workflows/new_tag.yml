# This Github action is triggered when a new (non release-candidate, aka not '-rc') tag is pushed in master branch:
# - compute tests coverage
# - compute code complexity
# - publishes the library on test.pypi
# - at last, define a new Github release.
name: New tag

on:
  workflow_dispatch:
  create:

jobs:
  gate:
    if: ${{ github.event_name == 'workflow_dispatch' || (startsWith(github.ref, 'refs/tags/') && !contains(github.ref_name, '-rc')) }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "gate passed"

  shellcheck:
    if: ${{ always() && needs.gate.result == 'success' }}
    needs:
      - gate
    uses: ${{ github.repository }}/.github/workflows/_shellcheck.yml@${{ github.ref }}
    secrets: inherit

  tests_and_coverage:
    needs:
      - gate
    uses: ${{ github.repository }}/.github/workflows/_pytest_coverage.yml@${{ github.ref }}
    with:
      py-version: "3.13"
      min-coverage: 85
    secrets:
      codecov-token: ${{ secrets.CODECOV_TOKEN }}

  complexity:
    needs:
      - tests_and_coverage
    uses: ${{ github.repository }}/.github/workflows/_complexity.yml@${{ github.ref }}
    with:
      py-version: "3.13"
    secrets: inherit

  testpypi:
    needs:
      - tests_and_coverage
    uses: ${{ github.repository }}/.github/workflows/_testpypi.yml@${{ github.ref }}
    with:
      py-version: "3.13"
    secrets: inherit

  release:
    needs:
      - testpypi
      - complexity
    if: ${{ needs.gate.result == 'success' }}
    uses: ${{ github.repository }}/.github/workflows/_release.yml@${{ github.ref }}
    # Optionally force a tag input; otherwise _release uses github.ref_name
    with:
      tag: ${{ github.ref_type == 'tag' && github.ref_name || '' }}
    secrets: inherit
